# TCP的三次握手/四次握手

## 三次握手（请求连接时）

首先服务端启动监听
1. 客户端发送连接请求，SYN=1，seq为生成的isn
2. 服务器收到客户端发来的连接请求，为此连接分配资源，然后发送确认收到连接请求的信息，SYN=1，ACK=1，seq=isn, ack为客户端发来的sequence+1
3. 客户端接受到服务器发来的确认信息，检查拿到的sequence值，是否是已过期的，如果是已过期的，就不处理或者发送reset，如果是正确的，发送ACK=1，sequence是之前的sequence值+1， ack是服务器发来的sequence+1。
4. 三次握手结束，连接建立

最后服务器如果收到了reset，或长时间未收到某个连接的响应，则会释放该连接的资源

**状态变化**：
发送方：SYN_SENT->ESTABILISHED
接收方：SYN_RECEIVED->ESTABILISHED

## 四次握手（结束连接）

1. 客户端发送FIN包，请求结束连接，带一个seq=u
2. 服务器收到客户端发来的FIN包，确认，发给客户端ACK包，ACK=1，seq=v(服务器自己的序号), ack=u+1
3. 这个时候服务器可能还有信息要发，等所有信息发完，就会给客户端发送一个结束连接的消息，FIN=1，ACK=当前连接序列号，seq=w（如果没有数据要发，w=v）, ack=u+1
4. 客户端收到服务器发来的FIN包之后，进入2MSL的Time WAIT状态，避免最后的ack丢失，ACK=1，seq=u+1,ack=w+1, 服务器收到后关闭该连接，客户端2MSL后也关闭连接

TIME_WAIT的存在是为了防止最后ACK丢失，那这样服务端会重发FIN，客户端还能收到，2MSL 是最大报文生存时间的2倍，不用RTT（往返时间）是因为RTT会被网络延迟影响，所有老连接的旧包都从网络上消失后，再允许重新使用同一个四元组。

# TCP滑动窗口和拥塞控制

## 滑动窗口

分为发送方控制的拥塞窗口(cwnd)和接收方控制的接受窗口(rwnd)：
- rwnd：接收方设定的允许接受的数据量大小，会附带在ACK包中给发送方，这个值可以为0，代表接受窗口满了
- cwnd：这个是由拥塞算法控制的

## 拥塞算法

- 慢启动：cwnd最初为1，然后还有一个慢启动阈值(ssthresh)，慢启动阈值初始值比较大，比如可以设置为64 MMS，也就是64个最大报文长度的值；每当发送方接受到一个ACK，cwnd就会以2的指数级增长，直到到达慢启动阈值时停止，或遇到丢包
- 拥塞控制：因为慢启动是指数级增长，所以会增长的很快，这个时候就需要一个慢启动阈值，如果cwnd>=ssthresh，那么就会进入到控制范围，没经过一个RTT，cwnd就会+1
- 快速重传：如果发生了丢包，并且收到了连续3个ACK，那么就会进入快速重传，发送方会快速充法丢失的那个包，并进去快速恢复阶段，如果没有收到3个连续ACK，那么就会重新回到慢启动初始状态，ssthresh=max(cwnd/2,2), cwnd变回1，再次开始重新增长
- 快速恢复：如果收到连续3个ACK，那说明后面的包是收到的，只有中间这一个丢了，那么慢启动阈值=cwnd/2, cwnd = ssthresh+3, 收到ACK包后进入拥塞控制阶段，如果仍然丢失，那就回到慢启动
## 超时重传

发送一个数据包后，启动重传计时器，如果超过计时器时间还未收到ATK，那就重新发送
这个重传计时器的时间不是固定的，是计算出来的

#  IP 分片

当传输的IP数据包体大小超过MTU（最大传输单元）时，就需要分片

分片时IP首部中包含的几个关键字：标识符（identification），标识位（Flag），片位移（fragment offset）
- 标识符：同一个数据包分出来的分片，标识符要一致
- 标识位：第一位：必须是0，第二位：能否分片，第三位：是否有更多分片，1位有，0位最后一个分片
- 片位移：表示该分片在原始数据包中的位置

分片重组： 
- 在最终目的地主机中，会重组分片，根据源IP，目的地IP，标识符，协议类型来判断分片是否属于同于数据包，然后进行重组；
- 如果在重组中发现其中一个分片丢失，那么就会丢失整段分片，需要发送方重新发送

分片的问题：
- 会增加丢包风险
- 会增加CPU计算消耗
- 会更容易受到攻击

# ARP

## ARP是什么

ARP维护IP和网卡MAC地址的映射

## ARP如何工作

当一台主机想要访问网络，要发送数据包，首先会向同一局域网中的所有主机广播ARP请求，询问拥有这一段IP地址的主机的MAC地址，拥有该IP地址的主机收到请求后会单播应答，回复自己的MAC地址，然后该主机会将这个映射缓存起来

## ARP欺骗

中间人攻击：黑客主机冒充真正拥有该IP的主机，将假的MAC地址发给请求方，而请求方不会对MAC进行验证，这就会在接下来的通信中，请求方将自己的数据包全部发给黑客主机，黑客主机可以获取发送方的所有信息

### 防止ARP欺骗

- 交换机防护：由交换机验证IP和MAC之间的映射，如果不对，则丢弃
- 网络隔离：攻击只能影响某一个区域内的网络，不会影响到其他区域
- 加密通信：使用HTTPS或者 VPN等加密协议，黑客没法解包数据包来获得信息
- 异常检测：检测ARP变化，频繁变化就发警告

# ICMP

ICMP是用于传递错误信息和网络诊断的协议，不传输数据

Ping：可以测试连通性
	- 主机A向主机B发送echo request, 附带序列号和时间戳
	- 主机B收到主机A的请求
	- 主机B向主机A发送echo reply, 原样返回数据
	- 主机A收到echo reply, 计算RTT，判断是否丢包

Traceroute：可以追踪路由路径
	- 根据跳数来进行探测

## OSI七层模型

- **应用层**：浏览器发 HTTP 请求
- **表示层**：TLS 加密
- **会话层**：维持 HTTPS 会话
- **传输层**：TCP 建立三次握手
- **网络层**：IP 寻址、路由选择
- **数据链路层**：交换机看 MAC 转发帧
- **物理层**：光纤传输比特流
### **OSI vs TCP/IP 四层模型（必背）**

TCP/IP 四层：

| TCP/IP 层 | 对应 OSI           |
| -------- | ---------------- |
| 应用层      | 7-6-5 层（全部打包成一个） |
| 传输层      | 第 4 层            |
| 网络层      | 第 3 层            |
| 网络接口层    | 第 2 + 第 1 层      |

你可以这样说：
> **“OSI 是理论模型，TCP/IP 是实际使用的模型。”**

## TCP 报文头部里面有什么

- 源端口
- 目的端口
- 序列号：sequence，表示TCP数据流中第一个字节的序号
- ACK：确认号，有ACK就表明前面发的数据都收到了，值为sequence + 1
- 数据偏移：TCP头部长度
- 保留位
- 控制标识位
	- Urgent：表示紧急指针是否有效
	- ACK：表示ACK是否有效
	- Push：表示数据包是否要马上传递给应用层
	- RST：rest，表示是否要重置连接
	- SYN: 同步序列号
	- FIN： 表示是否为FIN包
- 窗口大小：接收窗口大小
- 校验和：用来验证数据完整性，TCP头部是否有错误，数据是否被错误路由
- 紧急指针

TCP在校验时候会验证伪头部，TCP头部，TCP数据

## IP头部里面有什么

- 版本号
- 源IP地址，目的IP地址
- 协议号
- TTL：IP最长存在时间，每过一跳就减1，防止路由环路
- 总长度
- IP头部长度
- 校验和：验证IP头部完整性

## MTU 和 MSS

MTU：数据链路层最大可传递的数据包的大小
MSS：TCP协议最大可以传递的数据量

MSS = MTU - IP首部（20字节）- TCP首部（20字节）= 1500-20-20 = 1460 字节

TCP建立链接协商MSS会出现三种情况：
1. 双方都是1460字节，那就按1460来传输
2. 不对等的情况下，取最小的
3. 如果有一方没有通告MSS，就按默认大小536字节

### 为什么要有MSS

为了避免IP分片，如果不协商MSS，如果发送方发送的数据大于MSS，那就会触发IP分片，首先这会造成CPU资源消耗，第二如果有分片丢失，那就需要整个包重传，影响网络传输效率。如果协商了MSS，TCP检测到报文大于MSS就会自动分次传递

## VLAN

1. 为什么要有vlan
   vlan 是在交换机内分为多个广播域，例如在一家公司中，可以每一个部门一个vlan, 不同的vlan不能再二层直接通信，这样就实现了安全隔离，并且每一个vlan内部的广播不会影响到其他vlan，这就避免了广播风暴的发生

## STP 和 RSTP

STP：通过阻塞一些端口，把原先的环形拓扑结构变成树形。
工作原理：
1. 先选举根桥，优先级最低的作为根桥，如果优先级相同，就选择MAC地址最小的
2. 选举根端口，在非根桥交换机上到根桥路径成本最小的作为根端口
3. 选取指定端口，在每个网段选取到根端口路径成本最小的作为指定端口
4. 阻塞端口，除了不是根端口，指定端口的端口

 STP的状态：Disable，Blocking，Listening，Learning（学习MAC映射），Forwarding（转发）
 STP收敛时间在30-50秒，所有的VLAN都共享一个生成树实例

---
 
RSTP(快速生成树)的状态：Discarding，Learning, Forwarding； 收敛速度快，1-2
RSTP的端口角色：根端口，替代端口（根端口备份），指定端口，备份端口（指定端口备份）
RSTP的端口类型：边缘端口（连接物理服务器的），P2P端口（两台交换机相互连接），共享端口

RSTP的工作原理：
1. 上游交换机发送Proposal BPDU
2. 下游交换机收到后先阻塞非边缘端口
3. 下游交换机发送Agreement
4. 上游交换机收到后切换到forwarding状态
5. 下游交换机在下其下游交换机发送proposal BPDU
## 链路聚合

把多条物理链路聚合为一条逻辑链路，这样可以增加带宽，提供冗余，能够实现负载均衡（流量在多条物理链路上传递）

工作原理：
首先会从数据包中提取关键信息，然后进行哈希计算，然后根据哈希计算的结果来选择哪一条物理链路

使用哈希计算的原因是为了保证数据包不乱序，例如同一源IP和目的IP的数据包走同一条路径
