
# 防火墙的工作机制

防火墙会划分信任区域：`Trust`, `UnTrust`, `DMZ`, `local`
- Trust：信任区域，内网区域，安全层级最高
- UnTrust：非信任区域，外网，互联网区域，安全层级最低
- DMZ：隔离区，放置对外服务器，外部访问到这一层为止，安全层级中等
- local：防火墙自己的流量

工作流程：trust区域访问外部untrust或者DMZ都是默认允许的，但是低安全层级的访问高安全层级的，或同级访问是默认禁止的，隔离区会配置一些安全规则。

## 安全规则

- 包过滤：通过检测源IP，目的IP，源端口，目的端口，协议，然后以一定的规则过选择允许或拒绝，这个工作在网络层和传输曾，因为IP，ICMP这些都工作在网络层； 但是它没办法检测应用层中的内容，容易被绕过
- 状态监测：这个是去检测TCP的状态，例如SYNC_SENT, SYNC_RECEIVE,ESTABLISHED,FIN_SENT的状态，这个工作在传输层

## ACL规则编写

规则要素：序号，协议，源地址，目的地址，端口，行为

遵循集中规则：
1. 最小权限原则：只允许必须的协议和端口
2. 自上而下原则：特殊规则最先写，然后写通用规则，最后deny
3. 精确服务定义：准确的端口号要优于端口范围，识别应用协议特征

## NAT

NAT做的事情就是将内网IP和公网IP做转换，作用：
- 节省公网IP资源
- 提供一定的安全性，外网没法直接通过你的内网IP找到你的计算机
- 对于企业来说，可以控制流量的出入口

类型：
- 静态NAT，内网IP和公网IP是1:1固定映射
- 动态NAT，内网的多个IP可以使用公网IP池，多对多
- PAT，多个内网IP公用一个公网IP池，一对多

在使用PAT的时候，路由器发现源IP是一个内网IP，就会把它转化为公网IP，修改端口，然后建立映射表，如果有回复的数据包，会通过映射表改回内网IP并发送到主机